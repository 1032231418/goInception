<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="hanchuanchuan">
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>审核规则 - goInception使用文档</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "\u5ba1\u6838\u89c4\u5219";
    var mkdocs_page_input_path = "rules.md";
    var mkdocs_page_url = "/hanchuanchuan/goInception/rules/";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> goInception使用文档</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">介绍</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../install/">安装</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../params/">调用选项</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../demo/">使用示例</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../config/">config.toml说明</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../options/">审核选项</a>
	    </li>
          
            <li class="toctree-l1 current">
		
    <a class="current" href="./">审核规则</a>
    <ul class="subnav">
            
    <li class="toctree-l2"><a href="#_1">审核规范及原则</a></li>
    
        <ul>
        
            <li><a class="toctree-l3" href="#_2">支持的语句类型</a></li>
        
            <li><a class="toctree-l3" href="#_3">插入语句检查项</a></li>
        
            <li><a class="toctree-l3" href="#_4">更新、删除语句检查项</a></li>
        
            <li><a class="toctree-l3" href="#_5">建表语句检查项</a></li>
        
            <li><a class="toctree-l3" href="#_10">修改表语句检查项</a></li>
        
        </ul>
    

    <li class="toctree-l2"><a href="#_18">说明</a></li>
    

    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../backup/">备份功能</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../osc/">DDL变更:pt-osc</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../ghost/">DDL变更:gh-ost</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../kill_stmt/">KILL操作</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../levels/">自定义审核级别</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../statistics/">统计功能</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../tree/">语法树打印</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../changelog/">更新日志</a>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">goInception使用文档</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>审核规则</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/hanchuanchuan/goInception/edit/master/docs/rules.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="_1">审核规范及原则</h1>
<p><strong>说明</strong>：下面所列出来的规则，不一定能覆盖所有goInception当前已经实现的功能，具体包括什么规则，还需要在使用过程中总结，发现，同时可以结合配置参数来详细了解这些规则。</p>
<h2 id="_2">支持的语句类型</h2>
<ul>
<li>use db：此时会检查这个库是不是存在，需要连接到线上服务器来判断。</li>
<li>set option：现在只需要支持set names charset，设置其它变量时都报错不支持。</li>
<li>创建数据库语句</li>
<li>插入语句（包括多值插入）</li>
<li>查询插入语句</li>
<li>删除语句（包括多表删除）</li>
<li>更新语句（包括多表更新）</li>
<li>创建表语句</li>
<li>删除表语句</li>
<li>修改表语句</li>
<li>Truncate表语句</li>
<li>inception命令集语句（包括管理命令）</li>
</ul>
<h2 id="_3">插入语句检查项</h2>
<ul>
<li>表是否存在</li>
<li>必须指定插入列表，也就是要对哪几个列指定插入值，如insert into t (id,id2) values(...)，（可配置）</li>
<li>必须指定值列表，与上面对应的列，插入的值是什么，必须要指定。</li>
<li>插入列列表与值列表个数相同，上面二者的个数需要相同，如果没有指定列列表（因为可配置），则值列表长度要与表列数相同。</li>
<li>不为null的列，如果插入的值是null，报错（可配置）</li>
<li>插入指定的列名对应的列必须是存在的。</li>
<li>插入指定的列列表中，同一个列不能出现多次。</li>
<li>插入值列表中的简单表达式会做检查，但具体包括什么不一一指定</li>
</ul>
<h2 id="_4">更新、删除语句检查项</h2>
<ul>
<li>表是否存在</li>
<li>必须有where条件（可配置）</li>
<li>delete语句不能有limit条件（可配置）</li>
<li>不能有order by语句（可配置）</li>
<li>影响行数大于10000条，则报警（数目可配置）</li>
<li>对WHERE条件这个表达式做简单检查，具体包括什么不一一指定</li>
<li>对更新列的值列表表达式做简单检查，具体不一一指定</li>
<li>对更新列对象做简单检查，主要检查列是不是存在等</li>
<li>多表更新、删除时，每个表必须要存在</li>
</ul>
<h2 id="_5">建表语句检查项</h2>
<h3 id="_6">表属性的检查项</h3>
<ul>
<li>这个表不存在</li>
<li>对于create table like，会检查like的老表是不是存在。</li>
<li>对于create table db.table，会检查db这个数据库是不是存在</li>
<li>表名、列名、索引名的长度不大于64个字节</li>
<li>如果建立的是临时表，则必须要以tmp为前缀</li>
<li>必须要指定建立innodb的存储引擎（可配置）</li>
<li>必须要指定utf8的字符集（字符串可配置，指定支持哪些字符集）</li>
<li>表必须要有注释（可配置）</li>
<li>表不能建立为分区表（可配置）</li>
<li>只能有一个自增列</li>
<li>索引名字不能是Primay</li>
<li>不支持Foreign key（可配置）</li>
<li>建表时，如果指定auto_increment的值不为1，报错（可配置）</li>
<li>如果自增列的名字不为id，说明有可能是有意义的，MySQL这样使用比较危险，所以报警（可配置）</li>
</ul>
<h3 id="_7">列属性的检查项</h3>
<ul>
<li>不能设置列的字符集（可配置）</li>
<li>列的类型不能使用集合、枚举、位图类型。（可配置）</li>
<li>列必须要有注释（可配置）</li>
<li>char长度大于20的时候需要改为varchar（长度可配置）</li>
<li>列的类型不能是BLOB/TEXT。（可配置）</li>
<li>每个列都使用not null（可配置）</li>
<li>如果列为BLOB/TEXT类型的，则这个列不能设置为NOT NULL。</li>
<li>如何是自增列，则使用无符号类型（可配置）</li>
<li>如果自增列，则长度必须要大于等于4个字节（可配置）</li>
<li>如果是timestamp类型的，则要必须指定默认值。</li>
<li>对于MySQL5.5版本（包含）以下的数据库，不能同时有两个TIMESTAMP类型的列，如果是DATETIME类型，则不能定义成DATETIME DEFAULT CURRENT_TIMESTAMP及ON UPDATE CURRENT_TIMESTAMP等语句。</li>
<li>每个列都需要定义默认值，除了自增列、主键列及大字段列之外（可配置）</li>
<li>不能有重复的列名</li>
</ul>
<h3 id="_8">索引属性检查项</h3>
<ul>
<li>索引必须要有名字</li>
<li>不能有外键（可配置）</li>
<li>Unique索引必须要以uniq_为前缀（可配置）</li>
<li>普通索引必须要以idx_为前缀（可配置）</li>
<li>索引的列数不能超过5个（数目可以配置）</li>
<li>表必须要有一个主键（可配置）</li>
<li>最多有5个索引（数目可配置）</li>
<li>建索引时，指定的列必须存在。</li>
<li>索引中的列，不能重复</li>
<li>BLOB列不能建做KEY</li>
<li>索引长度不能超过766</li>
<li>不能有重复的索引，名字及内容</li>
</ul>
<h3 id="_9">默认值检查项</h3>
<ul>
<li>BLOB/TEXT类型的列，不能有非NULL的默认值</li>
<li>MySQL5.5以下（含）的版本，对于DATETIME类型的列，不能有函数NOW()的默认值。</li>
<li>如果设置默认值为函数，则只能是NOW()。</li>
<li>如果默认值为NULL，但列类型为NOT NULL，或者是主键列，或者定义为自增列，则报错。</li>
<li>自增列不能设置默认值。</li>
</ul>
<h2 id="_10">修改表语句检查项</h2>
<ul>
<li>表是不是存在</li>
</ul>
<h3 id="_11">创建索引检查项</h3>
<ul>
<li>同上面创建表中的索引检查项</li>
</ul>
<h3 id="_12">加列检查项</h3>
<ul>
<li>同上面创建表中的列检查项</li>
</ul>
<h3 id="_13">修改表检查项</h3>
<ul>
<li>表是不是存在</li>
<li>如果语句块中存在多条对同一个表的修改语句，则建议合并成一个ALTER语句</li>
<li>列是否存在</li>
<li>剩下的同上面创建表，创建索引，创建列，默认值等检查项一样</li>
</ul>
<h3 id="_14">删除索引检查项</h3>
<ul>
<li>表是不是存在</li>
<li>检查索引是不是存在</li>
</ul>
<h3 id="_15">修改列的默认值检查项</h3>
<ul>
<li>同默认值检查项</li>
</ul>
<h3 id="_16">修改表属性</h3>
<ul>
<li>表属性只支持对存储引擎、表注释、自增值及默认字符集的修改操作。</li>
<li>修改存储引擎时检查是不是Innodb（可配置）。</li>
<li>字符集修改检查是不是属于设置参数的值（支持字符集可配置）。</li>
</ul>
<h3 id="_17">转换表字符集</h3>
<ul>
<li>字符集修改检查是不是属于设置参数的值（支持字符集可配置）。</li>
</ul>
<h1 id="_18">说明</h1>
<ul>
<li>SQL审核主要针对mysql 5.7版本，其他版本支持会有通用的支持，但细节处可能会有差异，如果有什么问题，欢迎提交Issues来共同建设。</li>
</ul>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../backup/" class="btn btn-neutral float-right" title="备份功能">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../options/" class="btn btn-neutral" title="审核选项"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/hanchuanchuan/goInception/" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../options/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../backup/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>

</body>
</html>
